<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
		"-//mybatis.org//DTD Mapper 3.0//EN" 
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace="com.itbank.reservation.ReservationDAO">
	
	<select id="selectList" resultType="reservation" parameterType="hashmap">
	<![CDATA[
		select hotel.ho_name,
		       room.ro_roomtype,
		       customer.cu_id,
		       customer.cu_name,
		       reservation.*
		from reservation
			   left outer join customer on customer.cu_id = reservation.re_cu_id
			   left outer join calendar on calendar.calendar_pk = reservation.re_calendar_pk
			   left outer join room on room.ro_pk = calendar.calendar_ro_pk
			   left outer join hotel on room.ro_ho_name = hotel.ho_name
			   left outer join admin on admin.ad_id = hotel.ho_ad_id
    	where admin.ad_id = #{ad_id}
    	and reservation.re_paydate >= (#{startDate}) 
    	and reservation.re_paydate <= (#{endDate})
    	order by reservation.re_paydate desc
	]]>	
	</select>
	
	<select id="selectCancelCount" resultType="string" parameterType="hashmap">
	<![CDATA[
		select count(*)
		from reservation
			   left outer join customer on customer.cu_id = reservation.re_cu_id
			   left outer join calendar on calendar.calendar_pk = reservation.re_calendar_pk
			   left outer join room on room.ro_pk = calendar.calendar_ro_pk
			   left outer join hotel on room.ro_ho_name = hotel.ho_name
			   left outer join admin on admin.ad_id = hotel.ho_ad_id
    	where admin.ad_id = #{ad_id}
    	and reservation.re_paydate >= (#{startDate}) 
    	and reservation.re_paydate <= (#{endDate})
    	and reservation.re_cancelyesorno = 'Y'
	]]>	
	</select>
	
	<select id="selectReservationCount" resultType="string" parameterType="hashmap">
		<![CDATA[
		select count(*)
		from reservation
			   left outer join customer on customer.cu_id = reservation.re_cu_id
			   left outer join calendar on calendar.calendar_pk = reservation.re_calendar_pk
			   left outer join room on room.ro_pk = calendar.calendar_ro_pk
			   left outer join hotel on room.ro_ho_name = hotel.ho_name
			   left outer join admin on admin.ad_id = hotel.ho_ad_id
    	where admin.ad_id = #{ad_id}
    	and reservation.re_paydate >= (#{startDate}) 
    	and reservation.re_paydate <= (#{endDate})
    	and reservation.re_cancelyesorno = 'N'
	]]>	
	</select>

	<!-- 예약 확인상태로 바꾸기 -->
	<update id="updateState" parameterType="string">
		update reservation set re_state='YES' where re_idx = #{re_idx}
	</update>
	
	<select id="selectEmail" resultType="string" parameterType="int">
		select customer.cu_email from reservation 
		join customer on reservation.re_cu_id=customer.cu_id
		where re_idx = #{re_idx}
	</select>

	<!-- 확인 버튼 클릭 시, 해당 날짜 객실 수량 -1 -->
	<update id="updateCount" parameterType="hashmap">
	<![CDATA[
		update calendar set calendar_count = calendar_count-1
			where calendar_pk in 
				(select calendar_pk
				from calendar
				join room on room.ro_pk = calendar.calendar_ro_pk
				where (calendar.calendar_date >= (select re_indate from reservation where re_idx=#{re_idx}) 
        and calendar.calendar_date < (select re_outdate from reservation where re_idx=#{re_idx})) and room.ro_pk = #{cal_pk})
        ]]>	
	</update>

</mapper>
